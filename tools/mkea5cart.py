#!/usr/bin/env python

# mkea5cart: make cartridge file from EA5 files
#
# Copyright (c) 2017 Ralph Benzinger <xdt99@endlos.net>
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, see <http://www.gnu.org/licenses/>.

import sys
import os.path


# pre-compiler assembly program that moves program to expansion RAM
mover = "\xaa\x01\x00\x00\x00\x00\x60\x10\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x60\x2a\x14\x45\x2f\x41\x35\x20\x50\x52\x4f\x47\x52\x41\x4d\x20\x20\x20\x20\x20\x20\x20\x20\x00\x03\x00\x00\x00\xc0\x20\xa0\x00\x05\xa0\xa0\x00\x80\x20\xa0\x00\x16\x0b\x02\x00\x01\x4a\x02\x01\x61\x37\x02\x02\x00\x0b\x06\xa0\x60\xf8\x03\x00\x00\x02\x10\xff\x02\x00\x01\x47\x02\x01\x61\x28\x02\x02\x00\x0f\x06\xa0\x60\xf8\x02\x00\x10\x00\x02\x01\x83\x00\x02\x02\x00\xe0\x06\xa0\x60\xf8\x02\x00\x83\x00\x02\x01\x60\x94\x02\x02\x00\x28\xcc\x31\x06\x42\x16\xfd\x02\x03\x60\x00\x02\x05\x83\x80\x02\x06\x1f\xfa\x04\x60\x83\x00\x05\xc3\x04\xd3\x02\x01\x60\x00\xc1\x31\xc0\xb1\x81\x82\x12\x01\xc0\x86\xc0\x31\xcd\x40\xcc\x31\x06\x42\x15\xfd\xc1\x04\x16\xf0\x04\xe0\x60\x00\x04\x60\x60\xbc\xc1\x60\x83\x80\x02\x00\x10\x00\x02\x01\x83\x00\x02\x02\x00\xe0\x06\xa0\x61\x10\x04\xc0\x02\x01\x20\x20\x02\x02\x03\x00\x06\xa0\x60\xe0\x04\x55\xd8\x20\x83\xe1\x8c\x02\x02\x60\x40\x00\xd8\x00\x8c\x02\xd8\x01\x8c\x00\x06\x02\x16\xfc\x04\x5b\xd8\x20\x83\xe1\x8c\x02\x02\x60\x40\x00\xd8\x00\x8c\x02\xd8\x31\x8c\x00\x06\x02\x16\xfc\x04\x5b\xd8\x20\x83\xe1\x8c\x02\x02\x40\x3f\xff\xd8\x00\x8c\x02\xdc\x60\x88\x00\x06\x02\x16\xfc\x04\x5b\x50\x4c\x45\x41\x53\x45\x20\x57\x41\x49\x54\x20\x2e\x2e\x2e\x33\x32\x4b\x20\x4d\x49\x53\x53\x49\x4e\x47"


if len(sys.argv) != 4:
    sys.exit("usage: mkea5cart.py <first ea5 file> <cart file> <program entry>")

try:
    fn, ext = os.path.splitext(sys.argv[1])

    with open(sys.argv[2], "wb") as fout:
        namedmover = mover[:0x15] + "%-20s" % sys.argv[3][:20] + mover[0x29:]
        fout.write(namedmover)
        fout.write(chr(0) * (8192 - len(mover)))  # pad first bank

        while True:
            nextfn = fn + ext
            with open(nextfn, "rb") as fin:
                print "adding ...", nextfn
                data = fin.read()
            fout.write(data)
            fout.write(chr(0) * (8192 - len(data)))  # pad
            if data[0:2] == "\x00\x00":  # end of image marker
                break
            fn = fn[:-1] + chr(ord(fn[-1]) + 1)
except e:
    print "ERROR:", e
